#!/bin/bash
# run_test.sh - ะคะปะตั ะฟัะพัะธะฒะบะธ ะธ ัะตััะธัะพะฒะฐะฝะธะต ัะบะพัะพััะธ ะฝะฐ RPi

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ELF_PATH="$SCRIPT_DIR/firmware/BMI30.stm32h7.elf"
PYTHON_TEST="$SCRIPT_DIR/scripts/vendor_stream_read.py"

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ     BMI30 Test & Flash ะฝะฐ Raspberry Pi      โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะัะพะฒะตัะบะฐ ัะฐะนะปะพะฒ
if [ ! -f "$ELF_PATH" ]; then
    echo "[ERROR] ะัะพัะธะฒะบะฐ ะฝะต ะฝะฐะนะดะตะฝะฐ: $ELF_PATH"
    exit 1
fi

if [ ! -f "$PYTHON_TEST" ]; then
    echo "[ERROR] Python ัะตัั ะฝะต ะฝะฐะนะดะตะฝ: $PYTHON_TEST"
    exit 1
fi

# ะัะพะฒะตัะบะฐ OpenOCD
if ! command -v openocd &> /dev/null; then
    echo "[ERROR] OpenOCD ะฝะต ัััะฐะฝะพะฒะปะตะฝ"
    echo "ะะฐะฟัััะธ ัะฝะฐัะฐะปะฐ: ./run_setup.sh"
    exit 1
fi

# ะคะปะตัะธัะพะฒะฐะฝะธะต
echo "[1/3] ะคะปะตัะธัะพะฒะฐะฝะธะต ะฟัะพัะธะฒะบะธ ัะตัะตะท OpenOCD..."
echo "      ะญัะพ ะผะพะถะตั ะทะฐะฝััั 10-30 ัะตะบัะฝะด..."
echo ""

if openocd -s /usr/share/openocd/scripts \
    -f interface/raspberrypi-gpio.cfg \
    -f target/stm32h7x.cfg \
    -c "program $ELF_PATH verify reset exit" 2>&1 | grep -q "verified successfully"; then
    echo "[OK] ะคะปะตั ััะฟะตัะตะฝ!"
else
    echo "[WARN] ะคะปะตั ะผะพะถะตั ะฑััั ััะฟะตัะตะฝ (ะฟัะพะฒะตัั LED ะฝะฐ ST-Link)"
fi

echo ""
echo "[2/3] ะะถะธะดะฐะฝะธะต ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ััััะพะนััะฒะฐ (3 ัะตะบ)..."
sleep 3

echo ""
echo "[3/3] ะะฐะฟััะบ ัะตััะฐ ัะบะพัะพััะธ..."
echo "      ะะธะฐะณะฝะพััะธัะตัะบะธะน ัะตะถะธะผ ะดะพะปะถะตะฝ ะฒะบะปััะธัััั ะฐะฒัะพะผะฐัะธัะตัะบะธ"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ะะฐะฟััะบ ัะตััะฐ
python3 "$PYTHON_TEST" --full-mode 0 --quiet 2>&1 | head -20

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "โ ะขะตัั ะทะฐะฒะตััะตะฝ!"
echo ""
echo "๐ ะะตะทัะปััะฐัั:"
echo "   โข ะกะบะพัะพััั ะฒััะต 1200 KB/s = ะธะดะตะฐะปัะฝะพ"
echo "   โข ะกะบะพัะพััั 1000-1200 KB/s = ัะพัะพัะพ"  
echo "   โข ะกะบะพัะพััั 960+ KB/s = ัะพะพัะฒะตัััะฒัะตั ััะตะฑะพะฒะฐะฝะธัะผ"
echo "   โข ะกะบะพัะพััั < 960 KB/s = ะฟัะพะฑะปะตะผะฐ, ัะผ TROUBLESHOOTING.md"
echo ""
