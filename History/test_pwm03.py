import RPi.GPIO as GPIO
import time
from rpi_hardware_pwm import HardwarePWM

# ?????????
PWM_GPIO = 18  # GPIO ??? PWM
COUNTER_GPIO = 23  # GPIO ??? ???????? ?????????
TARGET_PULSES = 100  # ???????? ?????????? ?????????

# ??????????
pulse_count = 0

# ??????? ??? ???????? ?????????
def pulse_detected(channel):
    global pulse_count
    pulse_count += 1
    print(f"????????? ???????: {pulse_count}")
    if pulse_count >= TARGET_PULSES:
        pwm.change_duty_cycle(0)  # ?????????? PWM
        print(f"??????????? ????? {pulse_count} ?????????")

# ????????? GPIO
GPIO.setmode(GPIO.BCM)

# ????????? GPIO ??? ????????
GPIO.setup(COUNTER_GPIO, GPIO.IN, pull_up_down=GPIO.PUD_DOWN)
GPIO.add_event_detect(COUNTER_GPIO, GPIO.RISING, callback=pulse_detected)  # ???????????? ?? ??????

# ????????? PWM
pwm = HardwarePWM(pwm_channel=0, hz=1000)  # ??????? 1 ???
pwm.start(50)  # 50% ??????????

# ???????? ????
try:
    while pulse_count < TARGET_PULSES:
        time.sleep(0.1)
finally:
    pwm.stop()
    GPIO.cleanup()
    print("????????? ?????????.")
